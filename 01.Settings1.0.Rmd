---
title: "Data preparation"
author: "R Goto"
date: "2023-11-15"
output: html_document
---

## 1. Dataset

1.1. Download the files from 'National Panel Survey 2014-2015, Wave 4'
https://microdata.worldbank.org/index.php/catalog/2862
(accessed 15 November 2023)

**hh_sec_j1.csv** - included household (HH) food consumption (60 food items) in the last 7 days (total 3352 HHs)

**hh_sec_b.csv** - Roster of HH members and individual characteristics including: sex, age, eating food in the household in the last 7 days? (5587 obs)

1.2. Files organised separately (in folder 'files');

**food-id.csv** - 60 food items and code

**unitconv.csv** - unit conversion factors

**ediblep.csv** - edible portion


## 2. Settings

```{r eval=FALSE}
install.packages("tidyverse")
library(tidyverse)
```

2.1. open hh_sec_j1.csv and change variable names and select variables
```{r eval=FALSE}
dataJ1 <- read_csv("hh_sec_j1.csv") %>%   # open hh_sec_j1.csv
  rename(cons_yn = hh_j01, cons_unit = hh_j02_1, cons_quant = hh_j02_2) %>%   # change variable names
  select(y4_hhid, itemcode, cons_yn, cons_unit, cons_quant) # select variables to use
```

2.2. merge with food-id.csv to add IDs of 60 food items 
- food-id.csv, including itemcode (foodID) and itemname (foodname)
```{r eval=FALSE}
foodid <- read_csv("food-id.csv")

dataJ1 <- left_join(dataJ1, foodid, by = 'itemcode') %>% 
  relocate(dataJ1, itemname, .after = itemcode)
```

2.3. find only HHs consumed food in the HH in the last 7 day (i.e. cons_yn=1)
3352HHs - 3290HHs = 62HHs did not report food consumption
```{r eval=FALSE}
hh <- dataJ1 %>% 
  filter(cons_yn == 1) %>% 
  distinct(y4_hhid) %>% 
  mutate(hh = 1)

dataJ1cons <- left_join(hh, dataJ1, by = "y4_hhid")
```

## 3. Estimating food consumption amount in the HHs

3.1. merge with food consumption unit conversion factor (TNPSW4_unitconv.csv) to calculate the food consumption in grams (cons_g)
```{r eval=FALSE}
foodconv <- read_csv("unitconv.csv") %>% 
  select(-itemname)  # omit duplicate variable

dataJ1consA <- left_join(dataJ1cons, foodconv, by = c('itemcode', 'cons_unit'))
  mutate(cons_g = cons_quant*conv_fac)  # calculate the reported food amount in grams (cons_g)
```

3.2. merge edible portion function in TNPS_EP.csv to calculate estimate amount of food consumed in the HH (cons_g_hh)
```{r eval=FALSE}
df_EP <- read_csv("ediblep.csv") %>% 
  select(-itemname)

dataJ1consB <- left_join(dataJ1consA, df_EP, by = 'itemcode') %>% 
  mutate(cons_g_hh = cons_g*mean_EP)
```

3.3. save data with 60 food consumption in 3290HHs
```{r eval=FALSE}
write_csv(dataJ1consB, "hhcons.csv")
```




